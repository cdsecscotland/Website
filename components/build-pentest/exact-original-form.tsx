"use client"

import type React from "react"
import { useState, useMemo, useCallback, useActionState, useOptimistic, Fragment } from "react"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Checkbox } from "@/components/ui/checkbox"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Badge } from "@/components/ui/badge"
import { CheckCircle, Shield, Building, Users, MapPin, DollarSign, Calendar, Mail, Phone } from "lucide-react"
import { Listbox, Transition, Disclosure } from "@headlessui/react"
import { cn } from "@/lib/utils"
import ScrollAnimation from "../scroll-animation"
import { submitPentestForm } from "@/lib/actions"

// Original data structures exactly as they were
const industryAPTs = {
  financial: [
    {
      id: "lazarus",
      name: "Lazarus Group (APT38)",
      description: "North Korean group targeting financial institutions and SWIFT networks",
    },
    {
      id: "carbanak",
      name: "Carbanak/FIN7",
      description: "Financially motivated group targeting payment systems and banks",
    },
    {
      id: "cobalt",
      name: "Cobalt Group",
      description: "Cybercriminal group specializing in ATM and payment card attacks",
    },
    { id: "fin6", name: "FIN6", description: "Financial threat group targeting point-of-sale systems" },
  ],
  government: [
    {
      id: "cozy_bear",
      name: "Cozy Bear (APT29)",
      description: "Russian foreign intelligence service targeting government agencies",
    },
    {
      id: "fancy_bear",
      name: "Fancy Bear (APT28)",
      description: "Russian military intelligence group targeting defense and government",
    },
    {
      id: "comment_crew",
      name: "Comment Crew (APT1)",
      description: "Chinese group conducting cyber espionage against government targets",
    },
    { id: "turla", name: "Turla (APT29)", description: "Russian group targeting government and diplomatic entities" },
    {
      id: "kimsuky",
      name: "Kimsuky (APT43)",
      description: "North Korean group targeting government and defense organizations",
    },
  ],
  energy: [
    {
      id: "sandworm",
      name: "Sandworm (APT44)",
      description: "Russian group targeting critical infrastructure and energy facilities",
    },
    {
      id: "oilrig",
      name: "OilRig/Quilin (APT34)",
      description: "Iranian group targeting energy and government sectors",
    },
    { id: "elfin", name: "Elfin (APT33)", description: "Iranian group focusing on aviation and energy companies" },
  ],
  technology: [
    {
      id: "winnti",
      name: "Winnti Group (APT41)",
      description: "Chinese group targeting technology companies and software supply chains",
    },
    {
      id: "stone_panda",
      name: "Stone Panda (APT10)",
      description: "Chinese group targeting technology and intellectual property",
    },
    {
      id: "deep_panda",
      name: "Deep Panda (APT19)",
      description: "Chinese group targeting technology and healthcare sectors",
    },
  ],
  telecommunications: [
    { id: "apt10", name: "APT10", description: "Chinese group targeting telecommunications infrastructure" },
    {
      id: "mustang_panda",
      name: "Mustang Panda (APT27)",
      description: "Chinese group targeting telecommunications and government",
    },
    { id: "reaper", name: "Reaper (APT37)", description: "North Korean group targeting telecommunications and media" },
  ],
  healthcare: [
    {
      id: "winnti_apt41",
      name: "Winnti/APT41",
      description: "Chinese group targeting healthcare data and pharmaceutical research",
    },
    {
      id: "wizard_spider",
      name: "Wizard Spider",
      description: "Ransomware group frequently targeting healthcare institutions",
    },
  ],
  aerospace: [
    {
      id: "emissary_panda",
      name: "Emissary Panda (APT27)",
      description: "Chinese group targeting aerospace and defense contractors",
    },
  ],
  maritime: [
    {
      id: "leviathan",
      name: "Leviathan (APT40)",
      description: "Chinese group targeting maritime industries and shipping companies",
    },
  ],
  education: [
    {
      id: "charming_kitten",
      name: "Charming Kitten (APT35)",
      description: "Iranian group targeting academic institutions and researchers",
    },
    {
      id: "ocean_lotus",
      name: "Ocean Lotus (APT32)",
      description: "Vietnamese group targeting academic and research organizations",
    },
  ],
  infrastructure: [
    {
      id: "sandworm_infra",
      name: "Sandworm (APT44)",
      description: "Russian group targeting critical national infrastructure",
    },
    {
      id: "equation_group",
      name: "Equation Group",
      description: "Advanced group targeting critical infrastructure worldwide",
    },
  ],
  retail: [
    { id: "fin7_retail", name: "FIN7", description: "Point-of-sale malware and payment card theft in retail" },
    { id: "carbanak_retail", name: "Carbanak", description: "Retail payment system attacks and e-commerce fraud" },
  ],
  manufacturing: [
    { id: "winnti_mfg", name: "Winnti Group", description: "Industrial espionage and intellectual property theft" },
    { id: "apt1_mfg", name: "APT1", description: "Chinese group targeting manufacturing and industrial secrets" },
  ],
  legal: [
    { id: "apt1_legal", name: "APT1", description: "Legal document and client data theft" },
    { id: "apt28_legal", name: "APT28", description: "Law firm espionage operations" },
  ],
  other: [
    { id: "apt1_general", name: "APT1", description: "General corporate espionage across industries" },
    { id: "apt28_general", name: "APT28", description: "Multi-industry targeting and espionage" },
    { id: "apt29_general", name: "APT29", description: "Broad spectrum intelligence gathering" },
  ],
}

const allAPTs = [
  // Financial Services
  {
    id: "lazarus",
    name: "Lazarus Group (APT38)",
    description: "North Korean group targeting financial institutions and SWIFT networks",
    industry: "Financial Services",
  },
  {
    id: "carbanak",
    name: "Carbanak/FIN7",
    description: "Financially motivated group targeting payment systems and banks",
    industry: "Financial Services",
  },
  {
    id: "cozy_bear",
    name: "Cozy Bear (APT29)",
    description: "Russian foreign intelligence service targeting government agencies",
    industry: "Government/Defense",
  },
  // ... include all other APTs from original
]

const allFinancialAPTs = [
  {
    id: "lazarus",
    name: "Lazarus Group (APT38)",
    description: "North Korean group targeting financial institutions and SWIFT networks",
  },
  {
    id: "carbanak",
    name: "Carbanak/FIN7",
    description: "Financially motivated group targeting payment systems and banks",
  },
  {
    id: "cobalt",
    name: "Cobalt Group",
    description: "Cybercriminal group specializing in ATM and payment card attacks",
  },
  // ... include all other financial APTs from original
]

const industries = [
  { value: "financial", label: "Financial Services" },
  { value: "government", label: "Government/Defense" },
  { value: "energy", label: "Energy/Utilities" },
  { value: "technology", label: "Technology/IT" },
  { value: "telecommunications", label: "Telecommunications" },
  { value: "healthcare", label: "Healthcare/Pharmaceutical" },
  { value: "aerospace", label: "Aerospace/Defense Contractors" },
  { value: "maritime", label: "Maritime/Shipping" },
  { value: "education", label: "Academic/Research" },
  { value: "infrastructure", label: "Critical National Infrastructure" },
  { value: "retail", label: "Retail & E-commerce" },
  { value: "manufacturing", label: "Manufacturing" },
  { value: "legal", label: "Legal Services" },
  { value: "other", label: "Other" },
]

const budgetRanges = [
  { value: "5k-15k", label: "£5,000 - £15,000" },
  { value: "15k-30k", label: "£15,000 - £30,000" },
  { value: "30k-50k", label: "£30,000 - £50,000" },
  { value: "50k-100k", label: "£50,000 - £100,000" },
  { value: "100k+", label: "£100,000+" },
  { value: "discuss", label: "Prefer to discuss" },
]

const timelineOptions = [
  { value: "urgent", label: "ASAP (1-2 weeks)" },
  { value: "fast", label: "Fast track (2-4 weeks)" },
  { value: "standard", label: "Standard (4-8 weeks)" },
  { value: "planned", label: "Planned (2-3 months)" },
  { value: "flexible", label: "Flexible timeline" },
]

const testReasons = [
  {
    id: "compliance",
    label: "Regulatory Compliance",
    description: "Meeting industry-specific regulations (e.g., PCI DSS, HIPAA).",
  },
  { id: "security_audit", label: "Security Audit", description: "Preparing for a security audit or certification." },
  {
    id: "new_feature",
    label: "New Feature Testing",
    description: "Ensuring the security of newly implemented features or systems.",
  },
  {
    id: "risk_assessment",
    label: "Risk Assessment",
    description: "Identifying potential vulnerabilities and risks in your infrastructure.",
  },
  {
    id: "incident_response",
    label: "Incident Response",
    description: "Validating incident response plans and capabilities.",
  },
  {
    id: "vendor_assessment",
    label: "Vendor Assessment",
    description: "Assessing the security posture of third-party vendors.",
  },
  { id: "insurance", label: "Cyber Insurance", description: "Meeting requirements for cyber insurance coverage." },
  {
    id: "due_diligence",
    label: "Mergers & Acquisitions",
    description: "Performing security due diligence for M&A activities.",
  },
  { id: "other", label: "Other", description: "Other reasons not listed." },
]

export default function ExactOriginalForm() {
  const [serviceType, setServiceType] = useState<string>("")
  const [selectedReasons, setSelectedReasons] = useState<string[]>([])
  const [selectedIndustry, setSelectedIndustry] = useState<string>("")
  const [selectedAPTs, setSelectedAPTs] = useState<string[]>([])
  const [formData, setFormData] = useState({
    employees: "",
    locations: "",
    budget: "",
    timeline: "",
    firstName: "",
    lastName: "",
    email: "",
    phone: "",
    company: "",
    jobTitle: "",
    additionalInfo: "",
  })
  
  const [dataPrivacyConsent, setDataPrivacyConsent] = useState(false)
  const [marketingConsent, setMarketingConsent] = useState(false)
  const [showAllFinancial, setShowAllFinancial] = useState(false)
  const [showAllAPTs, setShowAllAPTs] = useState(false)

  const handleServiceTypeChange = useCallback((newServiceType: string) => {
    setServiceType(newServiceType)
    // Reset dependent fields when service type changes
    setSelectedReasons([])
    setSelectedIndustry("")
    setSelectedAPTs([])
  }, [])

  const handleReasonChange = useCallback((reasonId: string, checked: boolean) => {
    if (checked) {
      setSelectedReasons(prev => [...prev, reasonId])
    } else {
      setSelectedReasons(prev => prev.filter((id) => id !== reasonId))
    }
  }, [])

  const handleAPTChange = useCallback((aptId: string, checked: boolean) => {
    if (checked) {
      setSelectedAPTs(prev => [...prev, aptId])
    } else {
      setSelectedAPTs(prev => prev.filter((id) => id !== aptId))
    }
  }, [])

  const currentAPTs = useMemo(() => {
    if (showAllAPTs) {
      return allAPTs
    }
    if (selectedIndustry === "financial" && showAllFinancial) {
      return allFinancialAPTs
    }
    return industryAPTs[selectedIndustry as keyof typeof industryAPTs] || []
  }, [selectedIndustry, showAllFinancial, showAllAPTs])

  const [optimisticSubmitting, setOptimisticSubmitting] = useOptimistic(false)

  const [state, formAction, isPending] = useActionState(
    async (prevState: any, formData: FormData) => {
      setOptimisticSubmitting(true)
      
      if (!serviceType) {
        setOptimisticSubmitting(false)
        return { success: false, message: "Please select a service type." }
      }

      try {
        const result = await submitPentestForm(prevState, formData)
        setOptimisticSubmitting(false)
        return result
      } catch (error) {
        setOptimisticSubmitting(false)
        return { success: false, message: "An error occurred while submitting your request." }
      }
    },
    { success: false, message: "" }
  )

  const handleSubmit = (formData: FormData) => {
    // Add all the state data to formData
    formData.set("serviceType", serviceType)
    formData.set("selectedReasons", JSON.stringify(selectedReasons))
    formData.set("selectedIndustry", selectedIndustry)
    formData.set("selectedAPTs", JSON.stringify(selectedAPTs))
    
    Object.entries(formData).forEach(([key, value]) => {
      formData.set(key, value)
    })
    
    formData.set("dataPrivacyConsent", dataPrivacyConsent.toString())
    formData.set("marketingConsent", marketingConsent.toString())
    
    formAction(formData)
  }

  return (
    <section className="pt-8 pb-20 md:py-20 bg-white/95 dark:bg-charcoal/95 backdrop-blur-sm">
      <div className="container max-w-4xl">
        <ScrollAnimation animation="fade">
          <div className="text-center mb-16">
            <h2 className="text-4xl md:text-5xl font-bold text-charcoal dark:text-white mb-4">
              Build a Penetration Test
            </h2>
            <p className="text-xl text-charcoal/80 dark:text-white/80 max-w-3xl mx-auto">
              Create a customized penetration testing proposal tailored to your organization's specific needs, industry,
              and threat landscape.
            </p>
          </div>
        </ScrollAnimation>

        <form action={handleSubmit} className="space-y-8">
          {/* Service Type Selection */}
          <ScrollAnimation animation="slide-up" delay={0.2}>
            <Card className="shadow-lg border-0 bg-white dark:bg-charcoal/80">
              <CardHeader>
                <CardTitle className="flex items-center text-charcoal dark:text-white">
                  <Shield className="w-6 h-6 mr-3 text-blue-500" />
                  What type of security assessment do you need?
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div
                    className={`relative p-4 rounded-lg border-2 cursor-pointer transition-all ${
                      serviceType === "vulnerability-assessment"
                        ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20"
                        : "border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                    }`}
                    onClick={(e) => {
                      e.preventDefault()
                      handleServiceTypeChange("vulnerability-assessment")
                    }}
                  >
                    <div className="flex items-start space-x-3">
                      <Checkbox
                        checked={serviceType === "vulnerability-assessment"}
                        onCheckedChange={(checked) => {
                          handleServiceTypeChange(checked ? "vulnerability-assessment" : "")
                        }}
                        className="mt-1"
                        onClick={(e) => e.stopPropagation()}
                      />
                      <div className="flex-1">
                        <h4 className="font-semibold text-charcoal dark:text-white">Vulnerability Assessment</h4>
                        <p className="text-sm text-charcoal/70 dark:text-white/70 mt-1">
                          A systematic review of systems and networks to identify security weaknesses, misconfigurations, and missing patches without actively exploiting them.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div
                    className={`relative p-4 rounded-lg border-2 cursor-pointer transition-all ${
                      serviceType === "penetration-test"
                        ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20"
                        : "border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                    }`}
                    onClick={(e) => {
                      e.preventDefault()
                      handleServiceTypeChange("penetration-test")
                    }}
                  >
                    <div className="flex items-start space-x-3">
                      <Checkbox
                        checked={serviceType === "penetration-test"}
                        onCheckedChange={(checked) => handleServiceTypeChange(checked ? "penetration-test" : "")}
                        className="mt-1"
                        onClick={(e) => e.stopPropagation()}
                      />
                      <div className="flex-1">
                        <h4 className="font-semibold text-charcoal dark:text-white">Penetration Test</h4>
                        <p className="text-sm text-charcoal/70 dark:text-white/70 mt-1">
                          Simulated cyber attacks to actively exploit vulnerabilities and demonstrate real-world impact to your systems and data.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div
                    className={`relative p-4 rounded-lg border-2 cursor-pointer transition-all ${
                      serviceType === "threat-led-pentest"
                        ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20"
                        : "border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                    }`}
                    onClick={(e) => {
                      e.preventDefault()
                      handleServiceTypeChange("threat-led-pentest")
                    }}
                  >
                    <div className="flex items-start space-x-3">
                      <Checkbox
                        checked={serviceType === "threat-led-pentest"}
                        onCheckedChange={(checked) => handleServiceTypeChange(checked ? "threat-led-pentest" : "")}
                        className="mt-1"
                        onClick={(e) => e.stopPropagation()}
                      />
                      <div className="flex-1">
                        <h4 className="font-semibold text-charcoal dark:text-white">Threat-Led Penetration Test</h4>
                        <p className="text-sm text-charcoal/70 dark:text-white/70 mt-1">
                          Advanced testing that simulates real-world attack scenarios specific to your industry and known threat actors.
                        </p>
                      </div>
                    </div>
                  </div>

                  <div
                    className={`relative p-4 rounded-lg border-2 cursor-pointer transition-all ${
                      serviceType === "red-team"
                        ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20"
                        : "border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                    }`}
                    onClick={(e) => {
                      e.preventDefault()
                      handleServiceTypeChange("red-team")
                    }}
                  >
                    <div className="flex items-start space-x-3">
                      <Checkbox
                        checked={serviceType === "red-team"}
                        onCheckedChange={(checked) => handleServiceTypeChange(checked ? "red-team" : "")}
                        className="mt-1"
                        onClick={(e) => e.stopPropagation()}
                      />
                      <div className="flex-1">
                        <h4 className="font-semibold text-charcoal dark:text-white">Red Team</h4>
                        <p className="text-sm text-charcoal/70 dark:text-white/70 mt-1">
                          Full-scale adversarial simulation testing your organization's detection and response capabilities against sophisticated attacks.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </ScrollAnimation>

          {/* Test Reasons - Only show for non-vulnerability assessment */}
          {serviceType && serviceType !== "vulnerability-assessment" && (
            <ScrollAnimation animation="slide-up" delay={0.2}>
              <Card className="shadow-lg border-0 bg-white dark:bg-charcoal/80">
                <CardHeader>
                  <CardTitle className="flex items-center text-charcoal dark:text-white">
                    <Shield className="w-6 h-6 mr-3 text-blue-500" />
                    Why do you need a penetration test?
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {testReasons.map((reason) => (
                      <div
                        key={reason.id}
                        className={`relative p-4 rounded-lg border-2 cursor-pointer transition-all ${
                          selectedReasons.includes(reason.id)
                            ? "border-blue-500 bg-blue-50 dark:bg-blue-900/20"
                            : "border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"
                        }`}
                        onClick={(e) => {
                          e.preventDefault()
                          handleReasonChange(reason.id, !selectedReasons.includes(reason.id))
                        }}
                      >
                        <div className="flex items-start space-x-3">
                          <Checkbox
                            checked={selectedReasons.includes(reason.id)}
                            onCheckedChange={(checked) => handleReasonChange(reason.id, checked === true)}
                            className="mt-1"
                            onClick={(e) => e.stopPropagation()}
                          />
                          <div className="flex-1">
                            <h4 className="font-semibold text-charcoal dark:text-white">{reason.label}</h4>
                            <p className="text-sm text-charcoal/70 dark:text-white/70 mt-1">{reason.description}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            </ScrollAnimation>
          )}

          {/* Industry Selection - Only show for non-vulnerability assessment */}
          {serviceType && serviceType !== "vulnerability-assessment" && (
            <ScrollAnimation animation="slide-up" delay={0.3}>
              <Card className="shadow-lg border-0 bg-white dark:bg-charcoal/80">
                <CardHeader>
                  <CardTitle className="flex items-center text-charcoal dark:text-white">
                    <Building className="w-6 h-6 mr-3 text-green-500" />
                    What industry are you in?
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <Listbox value={selectedIndustry} onChange={setSelectedIndustry}>
                    <div className="relative">
                      <Listbox.Button className="relative w-full cursor-pointer rounded-lg bg-white dark:bg-charcoal py-2 pl-3 pr-10 text-left shadow-md focus:outline-none focus-visible:border-indigo-500 focus-visible:ring-2 focus-visible:ring-white focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-orange-300 sm:text-sm border border-gray-300 dark:border-gray-600">
                        <span className="block truncate">
                          {selectedIndustry ? industries.find(i => i.value === selectedIndustry)?.label : "Select your industry..."}
                        </span>
                        <span className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                          <svg className="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clipRule="evenodd" />
                          </svg>
                        </span>
                      </Listbox.Button>
                      <Transition
                        as={Fragment}
                        leave="transition ease-in duration-100"
                        leaveFrom="opacity-100"
                        leaveTo="opacity-0"
                      >
                        <Listbox.Options className="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white dark:bg-charcoal py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm">
                          {industries.map((industry) => (
                            <Listbox.Option
                              key={industry.value}
                              className={({ active }) =>
                                cn(
                                  "relative cursor-pointer select-none py-2 pl-10 pr-4",
                                  active ? "bg-amber-100 text-amber-900 dark:bg-amber-800 dark:text-amber-100" : "text-gray-900 dark:text-gray-100"
                                )
                              }
                              value={industry.value}
                            >
                              {({ selected }) => (
                                <>
                                  <span className={cn("block truncate", selected ? "font-medium" : "font-normal")}>
                                    {industry.label}
                                  </span>
                                  {selected ? (
                                    <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-amber-600">
                                      <CheckCircle className="h-5 w-5" aria-hidden="true" />
                                    </span>
                                  ) : null}
                                </>
                              )}
                            </Listbox.Option>
                          ))}
                        </Listbox.Options>
                      </Transition>
                    </div>
                  </Listbox>
                </CardContent>
              </Card>
            </ScrollAnimation>
          )}

          {/* APT Selection - Only show for non-vulnerability assessment */}
          {serviceType && serviceType !== "vulnerability-assessment" && selectedIndustry && currentAPTs.length > 0 && (
            <ScrollAnimation animation="slide-up" delay={0.4}>
              <Card className="shadow-lg border-0 bg-white dark:bg-charcoal/80">
                <CardHeader>
                  <div className="flex items-center justify-between flex-wrap gap-2">
                    <CardTitle className="flex items-center text-charcoal dark:text-white">
                      <Shield className="w-6 h-6 mr-3 text-red-500" />
                      {showAllAPTs ? "All Threat Actors" : "Industry-Specific Threat Actors"}
                    </CardTitle>
                    <div className="flex gap-2">
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => setShowAllAPTs(!showAllAPTs)}
                        className="text-sm"
                      >
                        {showAllAPTs ? "Show Industry Specific" : "See All APTs"}
                      </Button>
                      {selectedIndustry === "financial" && !showAllAPTs && (
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => setShowAllFinancial(!showAllFinancial)}
                          className="text-sm"
                        >
                          {showAllFinancial ? "Show Common" : "See All Financial"}
                        </Button>
                      )}
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {currentAPTs.map((apt) => (
                      <Disclosure key={apt.id}>
                        {({ open }) => (
                          <div className="border border-gray-200 dark:border-gray-700 rounded-lg">
                            <Disclosure.Button className="flex w-full items-center justify-between px-4 py-3 text-left">
                              <div className="flex items-center space-x-3">
                                <Checkbox
                                  checked={selectedAPTs.includes(apt.id)}
                                  onCheckedChange={(checked) => handleAPTChange(apt.id, checked === true)}
                                  onClick={(e) => e.stopPropagation()}
                                />
                                <span className="font-medium text-charcoal dark:text-white">{apt.name}</span>
                              </div>
                              <svg
                                className={cn(
                                  "h-5 w-5 text-gray-500 transition-transform",
                                  open ? "rotate-180" : ""
                                )}
                                fill="currentColor"
                                viewBox="0 0 20 20"
                              >
                                <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clipRule="evenodd" />
                              </svg>
                            </Disclosure.Button>
                            <Transition
                              enter="transition duration-100 ease-out"
                              enterFrom="transform scale-95 opacity-0"
                              enterTo="transform scale-100 opacity-100"
                              leave="transition duration-75 ease-out"
                              leaveFrom="transform scale-100 opacity-100"
                              leaveTo="transform scale-95 opacity-0"
                            >
                              <Disclosure.Panel className="px-4 pb-3 text-sm text-gray-500 dark:text-gray-400">
                                {apt.description}
                              </Disclosure.Panel>
                            </Transition>
                          </div>
                        )}
                      </Disclosure>
                    ))}
                  </div>
                </CardContent>
              </Card>
            </ScrollAnimation>
          )}

          {/* Contact and Budget Information */}
          <ScrollAnimation animation="slide-up" delay={0.5}>
            <Card className="shadow-lg border-0 bg-white dark:bg-charcoal/80">
              <CardHeader>
                <CardTitle className="flex items-center text-charcoal dark:text-white">
                  <Users className="w-6 h-6 mr-3 text-purple-500" />
                  Contact Information & Project Details
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="firstName">First Name *</Label>
                    <Input
                      id="firstName"
                      name="firstName"
                      type="text"
                      value={formData.firstName}
                      onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="lastName">Last Name *</Label>
                    <Input
                      id="lastName"
                      name="lastName"
                      type="text"
                      value={formData.lastName}
                      onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}
                      required
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="email">Email Address *</Label>
                    <Input
                      id="email"
                      name="email"
                      type="email"
                      value={formData.email}
                      onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="phone">Phone Number</Label>
                    <Input
                      id="phone"
                      name="phone"
                      type="tel"
                      value={formData.phone}
                      onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="company">Company *</Label>
                    <Input
                      id="company"
                      name="company"
                      type="text"
                      value={formData.company}
                      onChange={(e) => setFormData({ ...formData, company: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="jobTitle">Job Title</Label>
                    <Input
                      id="jobTitle"
                      name="jobTitle"
                      type="text"
                      value={formData.jobTitle}
                      onChange={(e) => setFormData({ ...formData, jobTitle: e.target.value })}
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="employees">Number of Employees</Label>
                    <Input
                      id="employees"
                      name="employees"
                      type="text"
                      value={formData.employees}
                      onChange={(e) => setFormData({ ...formData, employees: e.target.value })}
                      placeholder="e.g., 50-100"
                    />
                  </div>
                  <div>
                    <Label htmlFor="locations">Number of Locations</Label>
                    <Input
                      id="locations"
                      name="locations"
                      type="text"
                      value={formData.locations}
                      onChange={(e) => setFormData({ ...formData, locations: e.target.value })}
                      placeholder="e.g., 3"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="budget">Budget Range</Label>
                    <Listbox value={formData.budget} onChange={(value) => setFormData({ ...formData, budget: value })}>
                      <div className="relative">
                        <Listbox.Button className="relative w-full cursor-pointer rounded-lg bg-white dark:bg-charcoal py-2 pl-3 pr-10 text-left shadow-md focus:outline-none focus-visible:border-indigo-500 focus-visible:ring-2 focus-visible:ring-white focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-orange-300 sm:text-sm border border-gray-300 dark:border-gray-600">
                          <span className="block truncate">
                            {formData.budget ? budgetRanges.find(b => b.value === formData.budget)?.label : "Select budget range..."}
                          </span>
                          <span className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                            <svg className="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clipRule="evenodd" />
                            </svg>
                          </span>
                        </Listbox.Button>
                        <Transition
                          as={Fragment}
                          leave="transition ease-in duration-100"
                          leaveFrom="opacity-100"
                          leaveTo="opacity-0"
                        >
                          <Listbox.Options className="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white dark:bg-charcoal py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm">
                            {budgetRanges.map((budget) => (
                              <Listbox.Option
                                key={budget.value}
                                className={({ active }) =>
                                  cn(
                                    "relative cursor-pointer select-none py-2 pl-10 pr-4",
                                    active ? "bg-amber-100 text-amber-900 dark:bg-amber-800 dark:text-amber-100" : "text-gray-900 dark:text-gray-100"
                                  )
                                }
                                value={budget.value}
                              >
                                {({ selected }) => (
                                  <>
                                    <span className={cn("block truncate", selected ? "font-medium" : "font-normal")}>
                                      {budget.label}
                                    </span>
                                    {selected ? (
                                      <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-amber-600">
                                        <CheckCircle className="h-5 w-5" aria-hidden="true" />
                                      </span>
                                    ) : null}
                                  </>
                                )}
                              </Listbox.Option>
                            ))}
                          </Listbox.Options>
                        </Transition>
                      </div>
                    </Listbox>
                  </div>
                  <div>
                    <Label htmlFor="timeline">Preferred Timeline</Label>
                    <Listbox value={formData.timeline} onChange={(value) => setFormData({ ...formData, timeline: value })}>
                      <div className="relative">
                        <Listbox.Button className="relative w-full cursor-pointer rounded-lg bg-white dark:bg-charcoal py-2 pl-3 pr-10 text-left shadow-md focus:outline-none focus-visible:border-indigo-500 focus-visible:ring-2 focus-visible:ring-white focus-visible:ring-opacity-75 focus-visible:ring-offset-2 focus-visible:ring-offset-orange-300 sm:text-sm border border-gray-300 dark:border-gray-600">
                          <span className="block truncate">
                            {formData.timeline ? timelineOptions.find(t => t.value === formData.timeline)?.label : "Select timeline..."}
                          </span>
                          <span className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                            <svg className="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clipRule="evenodd" />
                            </svg>
                          </span>
                        </Listbox.Button>
                        <Transition
                          as={Fragment}
                          leave="transition ease-in duration-100"
                          leaveFrom="opacity-100"
                          leaveTo="opacity-0"
                        >
                          <Listbox.Options className="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white dark:bg-charcoal py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm">
                            {timelineOptions.map((timeline) => (
                              <Listbox.Option
                                key={timeline.value}
                                className={({ active }) =>
                                  cn(
                                    "relative cursor-pointer select-none py-2 pl-10 pr-4",
                                    active ? "bg-amber-100 text-amber-900 dark:bg-amber-800 dark:text-amber-100" : "text-gray-900 dark:text-gray-100"
                                  )
                                }
                                value={timeline.value}
                              >
                                {({ selected }) => (
                                  <>
                                    <span className={cn("block truncate", selected ? "font-medium" : "font-normal")}>
                                      {timeline.label}
                                    </span>
                                    {selected ? (
                                      <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-amber-600">
                                        <CheckCircle className="h-5 w-5" aria-hidden="true" />
                                      </span>
                                    ) : null}
                                  </>
                                )}
                              </Listbox.Option>
                            ))}
                          </Listbox.Options>
                        </Transition>
                      </div>
                    </Listbox>
                  </div>
                </div>

                <div>
                  <Label htmlFor="additionalInfo">Additional Information</Label>
                  <Textarea
                    id="additionalInfo"
                    name="additionalInfo"
                    value={formData.additionalInfo}
                    onChange={(e) => setFormData({ ...formData, additionalInfo: e.target.value })}
                    placeholder="Please provide any additional details about your requirements..."
                    className="min-h-[120px]"
                  />
                </div>

                <div className="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-6">
                  <div className="flex items-start space-x-3">
                    <Checkbox
                      id="dataPrivacyConsent"
                      checked={dataPrivacyConsent}
                      onCheckedChange={setDataPrivacyConsent}
                      className="mt-1"
                    />
                    <Label htmlFor="dataPrivacyConsent" className="text-sm leading-5">
                      I consent to the processing of my personal data for the purpose of this penetration testing
                      inquiry. *
                    </Label>
                  </div>

                  <div className="flex items-start space-x-3">
                    <Checkbox
                      id="marketingConsent"
                      checked={marketingConsent}
                      onCheckedChange={setMarketingConsent}
                      className="mt-1"
                    />
                    <Label htmlFor="marketingConsent" className="text-sm leading-5">
                      I would like to receive marketing communications about cybersecurity services and industry
                      insights.
                    </Label>
                  </div>
                </div>
              </CardContent>
            </Card>
          </ScrollAnimation>

          {/* Summary */}
          {serviceType && (
            <ScrollAnimation animation="slide-up" delay={0.6}>
              <Card className="shadow-lg border-0 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20">
                <CardHeader>
                  <CardTitle className="flex items-center text-charcoal dark:text-white">
                    <CheckCircle className="w-6 h-6 mr-3 text-green-500" />
                    Request Summary
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-charcoal dark:text-white mb-2">Service Type:</h4>
                    <Badge className="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                      {serviceType === "vulnerability-assessment" && "Vulnerability Assessment"}
                      {serviceType === "penetration-test" && "Penetration Test"}
                      {serviceType === "threat-led-pentest" && "Threat-Led Penetration Test"}
                      {serviceType === "red-team" && "Red Team"}
                    </Badge>
                  </div>

                  {selectedReasons.length > 0 && (
                    <div>
                      <h4 className="font-semibold text-charcoal dark:text-white mb-2">Reasons for Testing:</h4>
                      <div className="flex flex-wrap gap-2">
                        {selectedReasons.map((reasonId) => {
                          const reason = testReasons.find((r) => r.id === reasonId)
                          return (
                            <Badge key={reasonId} variant="secondary">
                              {reason?.label}
                            </Badge>
                          )
                        })}
                      </div>
                    </div>
                  )}

                  {selectedIndustry && (
                    <div>
                      <h4 className="font-semibold text-charcoal dark:text-white mb-2">Industry:</h4>
                      <Badge className="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                        {industries.find((i) => i.value === selectedIndustry)?.label}
                      </Badge>
                    </div>
                  )}

                  {selectedAPTs.length > 0 && (
                    <div>
                      <h4 className="font-semibold text-charcoal dark:text-white mb-2">Selected Threat Actors:</h4>
                      <div className="flex flex-wrap gap-2">
                        {selectedAPTs.map((aptId) => {
                          const apt = showAllAPTs
                            ? allAPTs.find((a) => a.id === aptId)
                            : selectedIndustry === "financial" && showAllFinancial
                              ? allFinancialAPTs.find((a) => a.id === aptId)
                              : currentAPTs.find((a) => a.id === aptId)
                          return (
                            <Badge key={aptId} className="bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                              {apt?.name}
                            </Badge>
                          )
                        })}
                      </div>
                    </div>
                  )}

                  <div className="pt-6 border-t border-gray-200 dark:border-gray-700">
                    <Button
                      type="submit"
                      size="lg"
                      disabled={isPending || optimisticSubmitting || !dataPrivacyConsent}
                      className="w-full bg-charcoal dark:bg-brandyellow hover:bg-charcoal/90 dark:hover:bg-brightyellow text-white dark:text-charcoal font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {isPending || optimisticSubmitting ? 'Submitting Request...' : 'Submit Penetration Test Request'}
                    </Button>

                    {state.message && (
                      <div className={cn(
                        "mt-4 p-4 rounded-lg",
                        state.success ? "bg-green-50 text-green-800 dark:bg-green-900/20 dark:text-green-200" : "bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-200"
                      )}>
                        {state.message}
                      </div>
                    )}
                  </div>
                </CardContent>
              </Card>
            </ScrollAnimation>
          )}
        </form>
      </div>
    </section>
  )
}